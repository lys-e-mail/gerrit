{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "3fd40ffb_8bf75499",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-04-19T12:22:54Z",
      "side": 1,
      "message": "This would still create an overhead even if there are no plugins installed or using this feature.\n\nSee the method definition at L598-L623.\n\nWhat\u0027s the runtime execution slowdown introduced? Did you measure it?\nHave you explored the option of skipping this altogether if there are no listeners implementing the `TaskParker` interface?",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f33f6078_b7736640",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1012457
      },
      "writtenOn": "2024-04-22T17:39:10Z",
      "side": 1,
      "message": "\u003e This would still create an overhead even if there are no plugins installed or using this feature.\n\u003e \n\u003e See the method definition at L598-L623.\n\u003e \n\u003e What\u0027s the runtime execution slowdown introduced? Did you measure it?\n\nI add a stopwatch around `onStart()` and `onStop()` and hardly noticed a difference. It was less than 3 microseconds for each of those calls.\n\n\u003e Have you explored the option of skipping this altogether if there are no listeners implementing the `TaskParker` interface?\n\nDo you still think this option needs to be explored given there isn\u0027t a considerable overhead? L598-L623 should mostly be no-op if there are no listeners.",
      "parentUuid": "3fd40ffb_8bf75499",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0996ceb1_c6b51737",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-04-26T09:29:17Z",
      "side": 1,
      "message": "Sure, 3 micros is nothing ðŸ˜Š How many times the `onStart()` is called per minute in your production system? Can you count them somehow?",
      "parentUuid": "f33f6078_b7736640",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3ec7f033_2e0a7ad6",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2024-04-26T19:37:42Z",
      "side": 1,
      "message": "We can add an emptiness check here too:\n\n```suggestion\n      if (!listeners.isEmpty() \u0026\u0026 !isReadyToStart(task)) {\n```\n\n\u003e How many times the onStart() is called per minute in your production system? Can you count them somehow?\n\nWe don\u0027t have a good way to count that in production today. I can think of some nice ways to do it, but it would take us a few weeks (sadly) to get that into production.",
      "parentUuid": "0996ceb1_c6b51737",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c04eee86_46fc19b7",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1012457
      },
      "writtenOn": "2024-04-26T21:05:53Z",
      "side": 1,
      "message": "\u003e We can add an emptiness check here too:\n\u003e \n\u003e ```suggestion\n\u003e       if (!listeners.isEmpty() \u0026\u0026 !isReadyToStart(task)) {\n\u003e ```\n\u003e \n\nI have added it now. `isEmpty()` does not specifically check if we have empty `TaskParkers`, but empty `TaskListeners` and `TaskParkers` combined. That is still a worthwhile check to have as folks who don\u0027t have any registered listeners will skip these new methods.\n\n\u003e \u003e How many times the onStart() is called per minute in your production system? Can you count them somehow?\n\u003e \n\u003e We don\u0027t have a good way to count that in production today. I can think of some nice ways to do it, but it would take us a few weeks (sadly) to get that into production.",
      "parentUuid": "3ec7f033_2e0a7ad6",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "02e2b75b_b44e8664",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2024-04-29T18:43:31Z",
      "side": 1,
      "message": "\u003e \u003e \u003e How many times the onStart() is called per minute in your production system? Can you count them somehow?\n\u003e \u003e \n\u003e \u003e We don\u0027t have a good way to count that in production today. I can think of some nice ways to do it, but it would take us a few weeks (sadly) to get that into production.\n\nMartin pinged me on the side and suggested writing some quick benchmark code to see if no-op task throughput is affected by this change. Kaushik is going to give that a try and post the results.",
      "parentUuid": "c04eee86_46fc19b7",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e924a72f_ea82cdac",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1012457
      },
      "writtenOn": "2024-05-01T17:03:12Z",
      "side": 1,
      "message": "I created a benchmark[1] using the acceptance test framework that executes 500k no-op tasks. An average of 10 runs took 3247ms without this change and 3265ms with it, when I ran it (using [2]) on my Macbook (Apple M1 Max with 32GB memory). The difference does not seem significant. \n\n[1] https://gerrit-review.googlesource.com/c/gerrit/+/423857/1/javatests/com/google/gerrit/acceptance/server/util/WorkQueueBenchmarkIT.java\n\n[2] bazel test //javatests/com/google/gerrit/acceptance/server/util:server_util --test_output\u003dstreamed  --cache_test_results\u003dno  --test_sharding_strategy\u003ddisabled   --test_filter\u003dcom.google.gerrit.acceptance.server.util.WorkQueueBenchmarkIT#benchmark$",
      "parentUuid": "02e2b75b_b44e8664",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ce3781c2_34bf6cd3",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1012457
      },
      "writtenOn": "2024-05-07T23:47:16Z",
      "side": 1,
      "message": "\u003e I created a benchmark[1] using the acceptance test framework that executes 500k no-op tasks. An average of 10 runs took 3247ms without this change and 3265ms with it, when I ran it (using [2]) on my Macbook (Apple M1 Max with 32GB memory). The difference does not seem significant.\n\nA few more updates were done since I last ran the benchmark. Here are the numbers from a new run with the current patchset.\n\n  without change: 3273ms\n  with change  : 3326ms\n\n\u003e \n\u003e [1] https://gerrit-review.googlesource.com/c/gerrit/+/423857/1/javatests/com/google/gerrit/acceptance/server/util/WorkQueueBenchmarkIT.java\n\u003e \n\u003e [2] bazel test //javatests/com/google/gerrit/acceptance/server/util:server_util --test_output\u003dstreamed  --cache_test_results\u003dno  --test_sharding_strategy\u003ddisabled   --test_filter\u003dcom.google.gerrit.acceptance.server.util.WorkQueueBenchmarkIT#benchmark$",
      "parentUuid": "e924a72f_ea82cdac",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "55802cac_847967c7",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 8
      },
      "lineNbr": 579,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2024-05-08T23:09:48Z",
      "side": 1,
      "message": "\u003e \u003e I created a benchmark[1] using the acceptance test framework that executes 500k no-op tasks. An average of 10 runs took 3247ms without this change and 3265ms with it, when I ran it (using [2]) on my Macbook (Apple M1 Max with 32GB memory). The difference does not seem significant.\n\u003e \n\u003e A few more updates were done since I last ran the benchmark. Here are the numbers from a new run with the current patchset.\n\u003e \n\u003e   without change: 3273ms\n\u003e   with change  : 3326ms\n\nLGTM",
      "parentUuid": "ce3781c2_34bf6cd3",
      "range": {
        "startLine": 579,
        "startChar": 10,
        "endLine": 579,
        "endChar": 31
      },
      "revId": "c14cabe5ab441ae6a5886705cfb56ea5ab0b1240",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}